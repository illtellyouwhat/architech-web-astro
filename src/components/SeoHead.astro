---
import { siteConfig } from '@/config/site';

export type JsonLdInput = Record<string, unknown> | Record<string, unknown>[] | null | undefined;

interface Props {
  title?: string;
  description?: string;
  hero?: string;
  seoType?: 'website' | 'article';
  publishedAt?: Date;
  updatedAt?: Date;
  jsonLd?: JsonLdInput;
}

const {
  title = siteConfig.title,
  description = siteConfig.description,
  hero,
  seoType = 'website',
  publishedAt,
  updatedAt,
  jsonLd
} = Astro.props;

const siteOrigin = Astro.site ?? new URL(siteConfig.url);
const canonicalUrl = new URL(Astro.url.pathname || '/', siteOrigin);
const ogImage = hero ? new URL(hero, siteOrigin).href : undefined;
const rssUrl = new URL('/rss.xml', siteOrigin).href;
const sitemapUrl = new URL('/sitemap-0.xml', siteOrigin).href;
const faviconSvg = new URL('/favicon.svg', siteOrigin).href;
const faviconIco = new URL('/favicon.ico', siteOrigin).href;
const published = publishedAt?.toISOString();
const updated = updatedAt?.toISOString();

const plausibleDomain = import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN;
const plausibleScript = import.meta.env.PUBLIC_PLAUSIBLE_SCRIPT ?? 'https://plausible.io/js/script.js';
const plausibleApi = import.meta.env.PUBLIC_PLAUSIBLE_API ?? 'https://plausible.io/api/event';
const plausibleDnt = import.meta.env.PUBLIC_PLAUSIBLE_DNT ?? 'true';
const gaId = import.meta.env.PUBLIC_GA_ID;
const umamiScript = import.meta.env.PUBLIC_UMAMI_SCRIPT;
const umamiWebsiteId = import.meta.env.PUBLIC_UMAMI_WEBSITE_ID;
const umamiDataHost = import.meta.env.PUBLIC_UMAMI_DATA_HOST;
const commentsToggleScript = new URL('/toggle-theme.js', siteOrigin).href;
---
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="generator" content={Astro.generator} />
  <title>{title}</title>

  <link rel="canonical" href={canonicalUrl.href} />
  <link rel="alternate" type="application/rss+xml" title={siteConfig.title} href={rssUrl} />
  <link rel="icon" type="image/svg+xml" href={faviconSvg} />
  <link rel="icon" type="image/x-icon" href={faviconIco} />
  <link rel="sitemap" href={sitemapUrl} />

  <meta name="title" content={title} />
  <meta name="description" content={description} />

  <meta property="og:type" content={seoType} />
  <meta property="og:url" content={canonicalUrl.href} />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:site_name" content={siteConfig.title} />
  {ogImage && <meta property="og:image" content={ogImage} />}

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={canonicalUrl.href} />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  {ogImage && <meta name="twitter:image" content={ogImage} />}

  {published && <meta property="article:published_time" content={published} />}
  {updated && <meta property="article:modified_time" content={updated} />}

  <meta name="theme-color" content="#0f172a" />
  <script is:inline src={commentsToggleScript} />

  {jsonLd && <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />}

  {plausibleDomain && (
    <script
      defer
      data-domain={plausibleDomain}
      data-api={plausibleApi}
      data-dnt={plausibleDnt}
      src={plausibleScript}
    />
  )}

  {gaId && (
    <>
      <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}></script>
      <script is:inline>
        {`window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', '${gaId}');`}
      </script>
    </>
  )}

  {umamiScript && umamiWebsiteId && (
    <script
      async
      src={umamiScript}
      data-website-id={umamiWebsiteId}
      data-host={umamiDataHost}
    />
  )}
</head>
