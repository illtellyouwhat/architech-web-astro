---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import BlogAside from '@/components/blog/BlogAside.astro';
import UtterancesComments from '@/components/blog/UtterancesComments.astro';
import { siteConfig } from '@/config/site';

export const getStaticPaths = async () => {
  const posts = await getCollection('posts', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post }
  }));
};

const { post } = Astro.props as { post: CollectionEntry<'posts'> };
const { Content, headings } = await post.render();

const description = post.data.excerpt ?? 'Read the latest update from Automation Architech.';
const publicationDate = post.data.date.toLocaleDateString(undefined, {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const asideDate = post.data.date.toLocaleDateString(undefined, {
  year: 'numeric',
  month: 'short',
  day: 'numeric'
});

const articleJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: post.data.title,
  description,
  datePublished: post.data.date.toISOString(),
  dateModified: post.data.date.toISOString(),
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': `${siteConfig.url}/blog/${post.slug}/`
  },
  author: {
    '@type': 'Organization',
    name: siteConfig.title,
    url: siteConfig.url
  },
  publisher: {
    '@type': 'Organization',
    name: siteConfig.title,
    logo: {
      '@type': 'ImageObject',
      url: `${siteConfig.url}/favicon.svg`
    }
  }
};

if (post.data.hero) {
  // @ts-ignore - JSON shape is flexible
  articleJsonLd.image = `${siteConfig.url}${post.data.hero}`;
}

const posts = (await getCollection('posts', ({ data }) => !data.draft)).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);
const tags = Array.from(new Set(posts.flatMap((entry) => entry.data.tags ?? []))).sort((a, b) =>
  a.localeCompare(b)
);
const issueTerm = `/blog/${post.slug}/`;

const indentClass = (depth: number) => {
  if (depth <= 2) return '';
  if (depth === 3) return 'pl-3';
  if (depth === 4) return 'pl-6';
  return 'pl-8';
};
---
<Layout
  title={post.data.title}
  description={description}
  hero={post.data.hero}
  seoType="article"
  publishedAt={post.data.date}
  updatedAt={post.data.date}
  jsonLd={articleJsonLd}
>
  <article class="mx-auto max-w-6xl px-4 py-12 sm:px-6 lg:px-8">
    <div class="flex flex-col gap-10 lg:flex-row">
      <div class="flex-1 space-y-10">
        <header class="space-y-4">
          <p class="text-sm uppercase tracking-[0.3em] text-gray-500">Blog</p>
          <h1 class="text-4xl font-semibold text-gray-900">{post.data.title}</h1>
          <div class="flex flex-wrap items-center gap-3 text-sm text-gray-500">
            <time datetime={post.data.date.toISOString()}>{publicationDate}</time>
            {post.data.tags?.length > 0 && (
              <ul class="flex flex-wrap gap-2">
                {post.data.tags.map((tag) => (
                  <li class="rounded-full bg-gray-100 px-3 py-1">#{tag}</li>
                ))}
              </ul>
            )}
          </div>
          {post.data.hero && (
            <img
              src={post.data.hero}
              alt="Hero image"
              class="h-80 w-full rounded-2xl object-cover"
              loading="lazy"
            />
          )}
        </header>

        <div class="prose prose-slate max-w-none">
          <Content />
        </div>

        <UtterancesComments issueTerm={issueTerm} />
      </div>

      <aside class="w-full space-y-6 lg:w-80">
        <section class="rounded-2xl border border-gray-100 bg-white p-5 shadow-sm">
          <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Article details</h2>
          <dl class="mt-4 space-y-3 text-sm text-gray-600">
            <div class="flex justify-between">
              <dt>Published</dt>
              <dd>{asideDate}</dd>
            </div>
            {post.data.tags?.length > 0 && (
              <div>
                <dt>Topics</dt>
                <dd class="mt-1 flex flex-wrap gap-2">
                  {post.data.tags.map((tag) => (
                    <span class="rounded-full bg-gray-100 px-3 py-1">#{tag}</span>
                  ))}
                </dd>
              </div>
            )}
          </dl>
        </section>

        {headings.length > 0 && (
          <section class="rounded-2xl border border-gray-100 bg-white p-5 shadow-sm">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-gray-500">On this page</h2>
            <ol class="mt-4 space-y-2 text-sm text-gray-600">
              {headings.map((heading) => (
                <li class={indentClass(heading.depth)}>
                  <a class="transition hover:text-gray-900" href={`#${heading.slug}`}>
                    {heading.text}
                  </a>
                </li>
              ))}
            </ol>
          </section>
        )}

        <BlogAside latestPosts={posts.slice(0, 5)} tags={tags} />
      </aside>
    </div>
  </article>
</Layout>
